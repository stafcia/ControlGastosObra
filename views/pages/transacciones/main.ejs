<div class="t-w-full">
  <%- include('../../partials/breadcrumbs'); %>

  <div class="t-px-2 sm:t-px-5 md:t-px-10 t-w-full t-min-w-[350px]">
    <div class="t-pt-4">
      <%- include('../../partials/page-title'); %>
    </div>

    <!-- Alertas y notificaciones -->
    <div id="alertContainer" class="t-mb-4"></div>

    <!-- Mensajes de error/éxito del servidor -->
    <% if (typeof query !== 'undefined') { %>
      <% if (query.error) { %>
        <div id="errorMessage" class="t-bg-red-100 t-border t-border-red-400 t-text-red-700 t-px-4 t-py-3 t-rounded t-mb-4 t-flex t-justify-between t-items-center">
          <span><%= query.error %></span>
          <button onclick="cerrarMensaje('errorMessage')" class="t-text-red-700 hover:t-text-red-900 t-font-bold t-text-lg t-leading-none">×</button>
        </div>
      <% } %>
      <% if (query.success) { %>
        <div id="successMessage" class="t-bg-green-100 t-border t-border-green-400 t-text-green-700 t-px-4 t-py-3 t-rounded t-mb-4 t-flex t-justify-between t-items-center">
          <span><%= query.success %></span>
          <button onclick="cerrarMensaje('successMessage')" class="t-text-green-700 hover:t-text-green-900 t-font-bold t-text-lg t-leading-none">×</button>
        </div>
      <% } %>
    <% } %>

    <!-- Banner del período actual -->
    <% if (periodoActual) { %>
      <div class="t-bg-blue-50 t-border t-border-blue-200 t-rounded-lg t-p-4 t-mb-6">
        <div class="t-flex t-items-center">
          <i class="fas fa-info-circle t-text-blue-600 t-mr-3"></i>
          <div>
            <h3 class="t-text-lg t-font-semibold t-text-blue-800">Período Actual: <%= periodoActual.descripcion %></h3>
            <p class="t-text-blue-700">
              Fechas permitidas: <%= periodoActual.fechaInicio %> - <%= periodoActual.fechaFin %>
              <% if (periodoCerrado) { %>
                <span class="t-ml-2 t-bg-red-100 t-text-red-800 t-px-2 t-py-1 t-rounded t-text-xs">PERÍODO CERRADO</span>
              <% } %>
            </p>
          </div>
        </div>
      </div>
    <% } else { %>
      <div class="t-bg-yellow-50 t-border t-border-yellow-200 t-rounded-lg t-p-4 t-mb-6">
        <div class="t-flex t-items-center">
          <i class="fas fa-exclamation-triangle t-text-yellow-600 t-mr-3"></i>
          <div>
            <h3 class="t-text-lg t-font-semibold t-text-yellow-800">Sin Período Activo</h3>
            <p class="t-text-yellow-700">No hay un período activo. No se pueden registrar transacciones.</p>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Dashboard de balance y transacciones pendientes -->
    <div class="t-grid t-grid-cols-1 lg:t-grid-cols-2 t-gap-6 t-mb-6">
      <!-- Balance personal -->
      <div class="t-bg-white t-border t-border-gray-200 t-rounded-lg t-p-6">
        <div class="t-flex t-justify-between t-items-center t-mb-4">
          <h2 class="t-text-xl t-font-semibold t-text-gray-800">
            <i class="fas fa-wallet t-mr-2"></i>Mi Balance
          </h2>
        </div>
        <div id="balancePersonal" class="t-grid t-grid-cols-2 lg:t-grid-cols-4 t-gap-4">
          <!-- Se llenará con JavaScript -->
        </div>
      </div>

      <!-- Transacciones pendientes -->
      <div class="t-bg-white t-border t-border-gray-200 t-rounded-lg t-p-6">
        <h2 class="t-text-xl t-font-semibold t-text-gray-800 t-mb-4">
          <i class="fas fa-clock t-mr-2"></i>Pendientes de Confirmar
        </h2>
        <div id="transaccionesPendientes">
          <!-- Se llenará con JavaScript -->
        </div>
      </div>
    </div>

    <!-- Sección principal de transacciones -->
    <div class="t-bg-white t-border t-border-gray-200 t-rounded-lg md:t-mb-10">
      <div class="t-p-5 t-border-b t-border-gray-200">
        <div class="t-flex t-justify-between t-items-center t-mb-4">
          <h2 class="t-text-xl t-font-semibold t-text-gray-800">
            <i class="fas fa-exchange-alt t-mr-2"></i>Historial de Transacciones
          </h2>
          <% if (periodoActual && !periodoCerrado) { %>
            <button onclick="abrirModalTransaccion()" class="t-bg-green-600 t-text-white t-px-4 t-py-2 t-rounded hover:t-bg-green-700 t-transition-colors">
              <i class="fas fa-plus-circle t-mr-2"></i>Nueva Transacción
            </button>
          <% } else { %>
            <span class="t-bg-gray-100 t-text-gray-500 t-px-4 t-py-2 t-rounded t-text-sm">
              <i class="fas fa-lock t-mr-2"></i>
              <%= periodoActual ? 'Período Cerrado' : 'Sin Período Activo' %>
            </span>
          <% } %>
        </div>
        
        <!-- Línea divisoria -->
        <div class="t-border-b t-border-gray-200 t-mb-4"></div>
        
        <!-- Filtros -->
        <div class="t-mb-4 t-grid t-grid-cols-1 md:t-grid-cols-2 lg:t-grid-cols-4 t-gap-4">
          <div>
            <label class="t-block t-text-sm t-font-medium t-text-gray-700 t-mb-1">Fecha Inicio:</label>
            <input type="date" id="fechaInicio" class="t-block t-w-full t-px-3 t-py-2 t-border t-border-gray-300 t-rounded-md t-shadow-sm focus:t-outline-none focus:t-ring-blue-500 focus:t-border-blue-500 t-text-sm">
          </div>
          
          <div>
            <label class="t-block t-text-sm t-font-medium t-text-gray-700 t-mb-1">Fecha Fin:</label>
            <input type="date" id="fechaFin" class="t-block t-w-full t-px-3 t-py-2 t-border t-border-gray-300 t-rounded-md t-shadow-sm focus:t-outline-none focus:t-ring-blue-500 focus:t-border-blue-500 t-text-sm">
          </div>
          
          <div>
            <label class="t-block t-text-sm t-font-medium t-text-gray-700 t-mb-1">Tipo:</label>
            <select id="filtroTipo" class="t-block t-w-full t-px-3 t-py-2 t-border t-border-gray-300 t-rounded-md t-shadow-sm focus:t-outline-none focus:t-ring-blue-500 focus:t-border-blue-500 t-text-sm">
              <option value="">Todos</option>
              <option value="Ingreso">Ingresos</option>
              <option value="Egreso">Egresos</option>
              <option value="Gasto">Gastos</option>
            </select>
          </div>
          
          <div>
            <label class="t-block t-text-sm t-font-medium t-text-gray-700 t-mb-1">Estado:</label>
            <select id="filtroEstado" class="t-block t-w-full t-px-3 t-py-2 t-border t-border-gray-300 t-rounded-md t-shadow-sm focus:t-outline-none focus:t-ring-blue-500 focus:t-border-blue-500 t-text-sm">
              <option value="">Todos</option>
              <option value="Pendiente">Pendientes</option>
              <option value="Confirmado">Confirmados</option>
            </select>
          </div>
        </div>
        
        <div class="t-flex t-justify-between t-items-center">
          <button onclick="aplicarFiltros()" class="t-bg-blue-600 t-text-white t-px-4 t-py-2 t-rounded hover:t-bg-blue-700 t-transition-colors t-text-sm">
            <i class="fas fa-search t-mr-2"></i>Filtrar
          </button>
          
          <button onclick="limpiarFiltros()" class="t-bg-gray-500 t-text-white t-px-4 t-py-2 t-rounded hover:t-bg-gray-600 t-transition-colors t-text-sm">
            <i class="fas fa-eraser t-mr-2"></i>Limpiar
          </button>
          
          <div class="t-text-sm t-text-gray-600">
            <span id="contadorTransacciones">Cargando...</span>
          </div>
        </div>

        <div class="t-flex t-flex-wrap">
          <div class="t-w-full t-overflow-hidden">
            <table id="tablaTransacciones" class="display nowrap datatable" style="width: 100%">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>De/Para</th>
                  <th>Concepto</th>
                  <th>Monto</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llenará con JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear/editar transacción -->
<div id="modalTransaccion" class="t-fixed t-inset-0 t-flex t-items-center t-justify-center t-z-50 t-hidden">
  <div class="t-absolute t-inset-0 t-bg-black t-opacity-50" id="modalOverlay"></div>

  <div class="t-bg-white t-rounded-lg t-shadow-xl t-w-full t-max-w-4xl t-z-10 t-relative t-m-4 t-max-h-[90vh] t-overflow-y-auto">
    <div class="t-flex t-justify-between t-items-center t-px-6 t-py-4 t-border-b t-border-gray-200">
      <h3 class="t-text-xl t-font-semibold t-text-gray-800" id="modalTitle">Nueva Transacción</h3>
      <button id="btnCerrarModal" class="t-text-gray-500 hover:t-text-gray-700">
        <svg class="t-w-6 t-h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <form id="transaccionForm" class="t-p-6">
      <input type="hidden" id="transaccionId" name="transaccionId" />

      <!-- Información del período -->
      <div class="t-bg-blue-50 t-border t-border-blue-200 t-rounded-lg t-p-3 t-mb-4">
        <div id="infoPeriodo" class="t-text-sm t-text-blue-700">
          <!-- Se llenará con JavaScript -->
        </div>
      </div>

      <div class="t-grid t-grid-cols-1 md:t-grid-cols-2 t-gap-4">
        <div class="form-group">
          <label for="fecha">Fecha <span class="t-text-red-500">*</span></label>
          <input type="date" id="fecha" name="fecha" required class="form-control" />
        </div>

        <div class="form-group">
          <label for="tipoMovimiento">Tipo de Movimiento <span class="t-text-red-500">*</span></label>
          <select id="tipoMovimiento" name="tipoMovimiento" required class="form-control" onchange="cambiarTipoMovimiento()">
            <option value="">Seleccione el tipo</option>
            <option value="Ingreso">Recibo dinero (Ingreso)</option>
            <option value="Egreso">Entrego dinero (Egreso)</option>
            <option value="Gasto">Gasto a obra/proveedor</option>
          </select>
        </div>

        <div class="form-group" id="usuarioOrigenGroup">
          <label for="usuarioOrigenId">Quién Entrega <span class="t-text-red-500">*</span></label>
          <select id="usuarioOrigenId" name="usuarioOrigenId" required class="form-control">
            <option value="">Seleccione usuario</option>
            <option value="<%= usuario.id %>"><%= usuario.nombreCompleto %> (Yo)</option>
            <% usuarios.forEach(u => { %>
              <option value="<%= u.id %>"><%= u.nombreCompleto %></option>
            <% }); %>
          </select>
        </div>

        <div class="form-group" id="usuarioDestinoGroup">
          <label for="usuarioDestinoId">Quién Recibe <span class="t-text-red-500">*</span></label>
          <select id="usuarioDestinoId" name="usuarioDestinoId" required class="form-control">
            <option value="">Seleccione usuario</option>
            <option value="<%= usuario.id %>"><%= usuario.nombreCompleto %> (Yo)</option>
            <% usuarios.forEach(u => { %>
              <option value="<%= u.id %>"><%= u.nombreCompleto %></option>
            <% }); %>
          </select>
        </div>

        <!-- Campos para gastos -->
        <div class="form-group t-hidden" id="tipoGastoGroup">
          <label for="tipoGasto">Tipo de Gasto <span class="t-text-red-500">*</span></label>
          <select id="tipoGasto" name="tipoGasto" class="form-control" onchange="cambiarTipoGasto()">
            <option value="">Seleccione tipo</option>
            <option value="Obra">Gasto en Obra</option>
            <option value="Proveedor">Pago a Proveedor</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div class="form-group t-hidden" id="obraGroup">
          <label for="obraId">Obra <span class="t-text-red-500">*</span></label>
          <select id="obraId" name="obraId" class="form-control">
            <option value="">Seleccione obra</option>
            <% obras.forEach(obra => { %>
              <option value="<%= obra.id %>"><%= obra.nombre %> - <%= obra.clienteNombre %></option>
            <% }); %>
          </select>
        </div>

        <div class="form-group t-hidden" id="proveedorGroup">
          <label for="proveedorNombre">Proveedor <span class="t-text-red-500">*</span></label>
          <input type="text" id="proveedorNombre" name="proveedorNombre" class="form-control" placeholder="Nombre del proveedor" />
        </div>

        <div class="form-group">
          <label for="formaPago">Forma de Pago <span class="t-text-red-500">*</span></label>
          <select id="formaPago" name="formaPago" required class="form-control">
            <option value="">Seleccione forma de pago</option>
            <option value="Efectivo">Efectivo</option>
            <option value="Cheque Cliente">Cheque Cliente</option>
            <option value="Cheque Cta Obra">Cheque Cta Obra</option>
            <option value="Transferencia Obra">Transferencia a cuenta de la Obra</option>
            <option value="Transferencia Brahma">Transferencia a cuenta Brahma</option>
          </select>
        </div>

        <div class="form-group">
          <label for="monto">Monto <span class="t-text-red-500">*</span></label>
          <div class="t-relative">
            <span class="t-absolute t-left-3 t-top-3 t-text-gray-500">$</span>
            <input type="number" id="monto" name="monto" required step="0.01" min="0.01" class="form-control t-pl-8" placeholder="0.00" />
          </div>
        </div>

        <div class="form-group md:t-col-span-2">
          <label for="concepto">Concepto/Descripción (Opcional)</label>
          <textarea id="concepto" name="concepto" class="form-control" rows="3" placeholder="Descripción detallada de la transacción"></textarea>
        </div>

        <div class="form-group md:t-col-span-2">
          <label for="observaciones">Observaciones (Opcional)</label>
          <textarea id="observaciones" name="observaciones" class="form-control" rows="2" placeholder="Notas adicionales"></textarea>
        </div>
      </div>

      <div class="t-flex t-justify-end t-space-x-3 t-mt-6">
        <button type="button" id="btnCancelar" class="btn btn--md t-bg-gray-200 hover:t-bg-gray-300 t-text-gray-700">
          Cancelar
        </button>
        <button type="submit" class="btn btn--md t-bg-green-600 hover:t-bg-green-700 t-text-white">
          <i class="fas fa-save t-mr-2"></i>Guardar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para confirmar/rechazar transacción -->
<div id="modalConfirmar" class="t-fixed t-inset-0 t-flex t-items-center t-justify-center t-z-50 t-hidden">
  <div class="t-absolute t-inset-0 t-bg-black t-opacity-50"></div>

  <div class="t-bg-white t-rounded-lg t-shadow-xl t-w-full t-max-w-md t-z-10 t-relative t-m-4">
    <div class="t-flex t-justify-between t-items-center t-px-6 t-py-4 t-border-b t-border-gray-200">
      <h3 class="t-text-xl t-font-semibold t-text-gray-800" id="modalConfirmarTitle">Confirmar Transacción</h3>
      <button id="btnCerrarModalConfirmar" class="t-text-gray-500 hover:t-text-gray-700">
        <svg class="t-w-6 t-h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div class="t-p-6">
      <div id="detalleTransaccion" class="t-mb-4">
        <!-- Se llenará con JavaScript -->
      </div>

      <div class="t-flex t-justify-end t-space-x-3">
        <button type="button" id="btnRechazar" class="btn btn--md t-bg-red-600 hover:t-bg-red-700 t-text-white">
          <i class="fas fa-times t-mr-2"></i>Rechazar
        </button>
        <button type="button" id="btnConfirmar" class="btn btn--md t-bg-green-600 hover:t-bg-green-700 t-text-white">
          <i class="fas fa-check t-mr-2"></i>Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Socket.IO Client -->
<script src="/socket.io/socket.io.js"></script>

<!-- Script para cerrar mensajes -->
<script>
function cerrarMensaje(id) {
  document.getElementById(id).remove();
}

// Auto-cerrar mensajes después de 5 segundos
setTimeout(() => {
  const messages = document.querySelectorAll('#errorMessage, #successMessage');
  messages.forEach(msg => msg.remove());
}, 5000);

// Establecer usuario actual globalmente
window.usuarioActual = {
  id: <%= usuario.id %>,
  nombreCompleto: "<%= usuario.nombreCompleto %>"
};

// Socket.IO initialization - connect to current origin or fallback to server port
const socket = io(window.location.hostname === 'localhost' && window.location.port === '3004' 
  ? 'http://localhost:3005' 
  : window.location.origin);

// Join user room for real-time updates
socket.emit('join-user-room', window.usuarioActual.id);

// Listen for transaction updates
socket.on('transaction-updated', (data) => {
  console.log('Transaction updated:', data);
  
  // Show notification
  const mensaje = data.action === 'confirmar' ? 'confirmó' : 'rechazó';
  mostrarAlerta(`Una transacción fue ${mensaje}`, 'info');
  
  // Reload data to reflect changes
  if (typeof cargarDatosPrincipales === 'function') {
    cargarDatosPrincipales();
  }
});

// Listen for new transactions
socket.on('new-transaction', (data) => {
  console.log('New transaction received:', data);
  
  // Show notification about new transaction
  mostrarAlerta(`Nueva transacción de $${data.amount.toLocaleString('es-MX', { minimumFractionDigits: 2 })} de ${data.from}`, 'info');
  
  // Reload data to show the new transaction in pending list
  if (typeof cargarDatosPrincipales === 'function') {
    cargarDatosPrincipales();
  }
});

socket.on('connect', () => {
  console.log('Conectado al servidor Socket.IO');
});

socket.on('disconnect', () => {
  console.log('Desconectado del servidor Socket.IO');
});
</script>